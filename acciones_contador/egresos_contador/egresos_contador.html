<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Egresos - Sistema Contable</title>
  <link rel="stylesheet" href="../../style_contador_slidebar.css" />
  <link rel="stylesheet" href="style_egresos_contador.css" />
</head>
<body>
  <!-- SIDEBAR -->
    <nav class="sidebar" id="sidebar">
        <button class="toggle-btn" id="toggle-btn">‚ò∞</button>
        <ul>
            <li><a href="../../index_contador.html"><span class="emoji">üè†</span><span class="text">Inicio</span></a></li>
            <li><a href="../ingresos_contador/ingresos_contador.html"><span class="emoji">üí∞</span><span class="text">Ingresos</span></a></li>
            <li><a href="../egresos_contador/egresos_contador.html"><span class="emoji">üí∏</span><span class="text">Egresos</span></a></li>            
            <li><a href="../impuestos_contador/impuestos_contador.html"><span class="emoji">üßÆ</span><span class="text">Impuestos</span></a></li>
            
            <li><a href="../reportes_contador/reportes_contador.html"><span class="emoji">üìà</span><span class="text">Reportes</span></a></li>

            <li><a href="../../cerrar_sesion.php"><span class="emoji">üö™</span><span class="text">Cerrar sesi√≥n</span></a></li>
        </ul>
    </nav>
  <script>
          // === FUNCIONES ESENCIALES PARA EL TOGGLE Y DROPDOWN ===

          // 1. Alternar la barra lateral (colapsar/expandir)
          document.getElementById("toggle-btn").addEventListener("click", function() {
              document.getElementById("sidebar").classList.toggle("collapsed");
          });

          // 2. Alternar el Dropdown (Contabilidad/Reportes)
          function toggleDropdown(dropdownId) {
              var dropdown = document.getElementById(dropdownId);
              if (dropdown) {
                  // Cierra todos los dem√°s dropdowns abiertos
                  document.querySelectorAll(".dropdown.open").forEach(openDropdown => {
                      if (openDropdown.id !== dropdownId) {
                          openDropdown.classList.remove("open");
                      }
                  });

                  // Abre o cierra el dropdown actual
                  dropdown.classList.toggle("open");
              }
          }
      </script>


  <!-- CONTENIDO PRINCIPAL -->
  <main class="main-content">
    <header class="top-bar">
      <h1>Registro de Egresos</h1>
      <p>Gesti√≥n de compras y gastos de la empresa (seg√∫n SUNAT Per√∫)</p>
    </header>
    <!-- BOT√ìN DE SELECCI√ìN DE CLIENTE EN EL HEADER -->
<!-- BOT√ìN DE SELECCI√ìN DE CLIENTE EN EL HEADER -->
<div class="header-cliente" style="display: flex; align-items: center; gap: 15px;">
  <button type="button" id="btn-header-seleccionar-cliente">
    Seleccionar Cliente
  </button>

  <!-- CLIENTE SELECCIONADO -->
  <div id="cliente-seleccionado" style="font-weight: 600;">
    Ning√∫n cliente seleccionado
  </div>
</div>

<!-- VENTANA FLOTANTE PARA SELECCIONAR CLIENTE -->
<div id="modal-clientes" class="modal-clientes" style="display:none; position: fixed; z-index: 2000; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.45); padding: 20px;">
  <div class="modal-clientes-content" role="dialog" aria-modal="true" aria-labelledby="modal-clientes-titulo" style="background: #fff; width: 90%; max-width: 700px; margin: 60px auto; padding: 20px; border-radius: 10px; max-height: 80vh; overflow-y: auto; box-shadow: 0 8px 20px rgba(0,0,0,0.25);">
    <button id="cerrar-modal-clientes" aria-label="Cerrar" style="float:right; cursor:pointer; font-size:22px;">‚úñ</button>

    <h2 id="modal-clientes-titulo" style="margin-top:0;">Seleccionar Cliente</h2>

    <!-- buscador -->
    <input id="buscadorClientes" type="text" placeholder="Buscar cliente por nombre..." autocomplete="off" style="width:100%; padding:8px; margin:8px 0 12px; box-sizing:border-box;" />

    <table class="tabla-clientes" style="width:100%; border-collapse: collapse; margin-top:5px;">
      <thead>
        <tr>
          <th style="border:1px solid #ccc; padding:8px; text-align:left;">Nombre / Raz√≥n Social</th>
          <th style="border:1px solid #ccc; padding:8px; text-align:left;">Nombre del Negocio</th>
          <th style="border:1px solid #ccc; padding:8px; text-align:center;">Acci√≥n</th>
        </tr>
      </thead>
      <tbody id="listaClientes">
        <!-- filas est√°ticas por defecto (se reemplazan si fetch devuelve datos) -->
      </tbody>
    </table>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  // elementos (IDs usados en tu HTML)
  const btnAbrir = document.getElementById("btn-header-seleccionar-cliente");
  const modal = document.getElementById("modal-clientes");
  const btnCerrar = document.getElementById("cerrar-modal-clientes");
  const lista = document.getElementById("listaClientes"); // tbody
  const buscador = document.getElementById("buscadorClientes");
  const nombreHeader = document.getElementById("cliente-seleccionado");

  // --- helpers ---
  function escapeHtml(txt = "") {
    return String(txt)
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;")
      .replace(/'/g, "&#039;");
  }

  function openModal() {
    if (!modal) return;
    modal.style.display = "block";
    modal.setAttribute("aria-hidden", "false");
    document.body.style.overflow = "hidden";
    if (buscador) {
      buscador.value = "";
      setTimeout(() => buscador.focus(), 50);
    }
    cargarClientes(); // carga inicial (sin query)
    trapFocus(modal);
  }

  function closeModal() {
    if (!modal) return;
    modal.style.display = "none";
    modal.setAttribute("aria-hidden", "true");
    document.body.style.overflow = "";
    releaseFocus();
  }

  // focus trap simple
  let lastFocused = null;
  function trapFocus(container) {
    lastFocused = document.activeElement;
    const focusables = 'a[href], area[href], input:not([disabled]), button:not([disabled]), [tabindex="0"]';
    const nodes = Array.from(container.querySelectorAll(focusables));
    if (nodes.length) nodes[0].focus();

    function keyHandler(e) {
      if (e.key === "Tab") {
        const first = nodes[0];
        const last = nodes[nodes.length - 1];
        if (e.shiftKey && document.activeElement === first) {
          e.preventDefault();
          last.focus();
        } else if (!e.shiftKey && document.activeElement === last) {
          e.preventDefault();
          first.focus();
        }
      } else if (e.key === "Escape") {
        closeModal();
      }
    }
    container._keyHandler = keyHandler;
    document.addEventListener("keydown", keyHandler);
  }
  function releaseFocus() {
    if (modal && modal._keyHandler) {
      document.removeEventListener("keydown", modal._keyHandler);
      delete modal._keyHandler;
    }
    if (lastFocused) lastFocused.focus();
    lastFocused = null;
  }

  // --- eventos abrir/cerrar ---
  if (btnAbrir) btnAbrir.addEventListener("click", (e) => { e.preventDefault(); openModal(); });
  if (btnCerrar) btnCerrar.addEventListener("click", closeModal);
  if (modal) {
    modal.addEventListener("click", (e) => {
      // clic en backdrop (fuera del contenido)
      if (e.target === modal) closeModal();
    });
  }

  // --- carga de clientes (intenta fetch a clientes_json.php?q=...) ---
  async function cargarClientes(q = "") {
    if (!lista) return;
    // estado loading en la tabla
    lista.innerHTML = '<tr><td colspan="3" style="padding:12px; text-align:center;">Cargando clientes...</td></tr>';
    try {
      const url = '../../clientes_json.php' + (q ? '?q=' + encodeURIComponent(q) : '');
      const resp = await fetch(url, { cache: 'no-store' });
      if (!resp.ok) throw new Error('HTTP ' + resp.status);
      const data = await resp.json();
      renderClientes(data || []);
    } catch (err) {
      // Si falla fetch, dejamos las filas est√°ticas (o mostramos error)
      console.warn('No se pudo obtener clientes desde clientes_json.php, usando filas est√°ticas si existen. Error:', err);
      if (!lista.querySelector('tr')) {
        lista.innerHTML = '<tr><td colspan="3" style="padding:12px; text-align:center;">Error al cargar clientes.</td></tr>';
      }
    }
  }

  // renderiza lista desde arreglo [{id, nombre, nombre_negocio, ...},...]
  // En renderClientes, asegurarnos de que cada bot√≥n transporte el id real
function renderClientes(items) {
  if (!lista) return;
  lista.innerHTML = '';
  if (!Array.isArray(items) || items.length === 0) {
    lista.innerHTML = '<tr><td colspan="3" style="padding:12px; text-align:center;">No se encontraron clientes.</td></tr>';
    return;
  }
  items.forEach(it => {
    const tr = document.createElement('tr');

    const tdNombre = document.createElement('td');
    tdNombre.style.padding = '8px';
    tdNombre.style.border = '1px solid #ccc';
    tdNombre.textContent = it.nombre || 'Sin nombre';

    const tdNegocio = document.createElement('td');
    tdNegocio.style.padding = '8px';
    tdNegocio.style.border = '1px solid #ccc';
    tdNegocio.textContent = it.nombre_negocio || '';

    const tdAcc = document.createElement('td');
    tdAcc.style.padding = '8px';
    tdAcc.style.border = '1px solid #ccc';
    tdAcc.style.textAlign = 'center';

    const btn = document.createElement('button');
    btn.className = 'seleccionar-cliente';
    btn.type = 'button';
    // IMPORTANT: agregamos data-id (id real del registro clientes)
    btn.dataset.id = it.id !== undefined ? String(it.id) : '';
    btn.dataset.nombre = it.nombre || '';
    btn.dataset.nombre_negocio = it.nombre_negocio || '';
    btn.textContent = 'Elegir';
    btn.addEventListener('click', () => seleccionarClienteDesdeBoton(btn));

    tdAcc.appendChild(btn);

    tr.appendChild(tdNombre);
    tr.appendChild(tdNegocio);
    tr.appendChild(tdAcc);

    lista.appendChild(tr);
  });
}

// Al seleccionar: rellenar el input visible y el input oculto id_cliente
function seleccionarClienteDesdeBoton(btn) {
  const nombre = btn.dataset.nombre || btn.textContent.trim();
  const id = btn.dataset.id || '';

  // Mostrar solo el nombre en el header
  if (nombreHeader) nombreHeader.innerText = nombre;

  // Rellenar el input del formulario (id="cliente")
  const inputid_Cliente = document.getElementById("id_cliente");
  if (inputid_Cliente) inputid_Cliente.value = nombre;


  closeModal();
}

// Env√≠o del formulario: mandamos id_cliente si existe
const form = document.getElementById("formEgreso");
if (form) {
  form.addEventListener("submit", async (e) => {
    e.preventDefault();

    const fecha = document.getElementById("fecha").value;
    const doc = document.getElementById("tipoComprobante").value;
    const entidad = document.getElementById("rucProveedor").value;
    const descripcion = document.getElementById("descripcion").value;
    const id_cliente = document.getElementById("id_cliente").value;
    const monto = document.getElementById("total").value;


    if (!fecha || !doc || !entidad || !descripcion || monto === "") {
      alert("Faltan campos obligatorios");
      return;
    }

    const payload = {
      fecha,
      doc,
      entidad,
      descripcion,
      id_cliente,
      monto
    };

    try {
      const resp = await fetch("egresos_contador.php", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });
      const data = await resp.json();
      
    } catch (err) {
      console.error(err);
      alert("Error en la comunicaci√≥n con el servidor.");
    }
  });
}

});
</script>

    <section class="form-container">
      <h2>Registrar nuevo egreso</h2>
      <form id="formEgreso" action="egresos_contador.php" method="POST">
        <div class="form-group">
          <label>Fecha del comprobante:</label>
          <input type="date" id="fecha" name="fecha" required />
        </div>

        <div class="form-group">
          <label>Tipo de comprobante:</label>
          <select id="tipoComprobante" name="doc" required>
            <option value="">Seleccione...</option>
            <option value="Factura">Factura</option>
            <option value="Boleta">Boleta</option>
            <option value="Recibo por Honorarios">Recibo por Honorarios</option>
            <option value="Voucher">Voucher</option>
          </select>
        </div>

        <div class="form-group">
          <label>RUC o DNI del proveedor:</label>
          <input type="text" id="rucProveedor" name="entidad" maxlength="11" placeholder="Ejemplo: 20123456789" required />
        </div>

        <input type="hidden" id="id_cliente" name="id_cliente" value="" />

        <div class="form-group">
          <label>Raz√≥n social o nombre:</label>
          <input type="text" id="razonSocial" name="razon" required />
        </div>

        <div class="form-group">
          <label>Descripci√≥n del gasto:</label>
          <input type="text" id="descripcion" name="descripcion"  placeholder="Ejemplo: Servicios de internet, compra de √∫tiles, etc." required />
        </div>

        <div class="form-group">
          <label>Base imponible (S/):</label>
          <input type="number" id="baseImponible" name="base" step="0.01" required />
        </div>

        <div class="form-group">
          <label>IGV (18%):</label>
          <input type="number" id="igv" name="igv" step="0.01" readonly />
        </div>

        <div class="form-group">
          <label>Total (S/):</label>
          <input type="number" id="total" name="monto" step="0.01" readonly />
        </div>

        <button type="submit">Registrar Egreso</button>
      </form>
    </section>

    <section class="tabla-egresos">
      <h3>Listado de egresos registrados</h3>
      <table>
        <thead>
          <tr>
            <th>Fecha</th>
            <th>Comprobante</th>
            <th>Proveedor</th>
            <th>Descripci√≥n</th>
            <th>Base (S/)</th>
            <th>IGV (S/)</th>
            <th>Total (S/)</th>
          </tr>
        </thead>
        <tbody id="tablaEgresosBody">
          <!-- Aqu√≠ se insertar√°n las filas din√°micamente -->
        </tbody>
      </table>
    </section>
  </main>

  <script src="/script.js"></script>
  <script src="script_contador_egresos.js"></script>
</body>
</html>
