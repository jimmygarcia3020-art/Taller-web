<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Reportes Contables</title>

  <link rel="stylesheet" href="../../style_contador_slidebar.css">
  <link rel="stylesheet" href="style_reportes_contador.css">
</head>

<body>

<!-- SIDEBAR -->
<nav class="sidebar" id="sidebar">
    <button class="toggle-btn" id="toggle-btn">‚ò∞</button>
    <ul>
        <li><a href="../../index_contador.html"><span class="emoji">üè†</span><span class="text">Inicio</span></a></li>
        <li><a href="../ingresos_contador/ingresos_contador.html"><span class="emoji">üí∞</span><span class="text">Ingresos</span></a></li>
        <li><a href="../egresos_contador/egresos_contador.html"><span class="emoji">üí∏</span><span class="text">Egresos</span></a></li>
        <li><a href="../impuestos_contador/impuestos_contador.html"><span class="emoji">üßÆ</span><span class="text">Impuestos</span></a></li>
        <li><a href="reportes_contador.html"><span class="emoji">üìà</span><span class="text">Reportes</span></a></li>
        <li><a href="../../cerrar_sesion.php"><span class="emoji">üö™</span><span class="text">Cerrar sesi√≥n</span></a></li>
    </ul>
</nav>

  <!-- CONTENIDO PRINCIPAL -->
  <main class="main-content">
    <h1>üìä Reportes Contables </h1>

    <!-- üî• NUEVA SECCI√ìN DE BOTONES PARA IR A REPORTES -->
   

    <style>
      .report-links {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        margin-bottom: 25px;
      }

      .btn-link {
        background-color: #4C8BF5;
        color: white;
        padding: 10px 18px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 15px;
        transition: 0.2s;
      }

      .btn-link:hover {
        background-color: #336FD1;
      }
    </style>

    <!-- --- RESTO DE TU CONTENIDO ORIGINAL --- -->

    <div class="actions-top">
      <button id="btnAgregar">‚ûï Agregar</button>
      <button id="btnSeleccionarCliente">üë§ Seleccionar Cliente</button>
    </div>

    <div id="modalClientes" role="dialog" aria-hidden="true">
      <div class="modal-clientes" role="document" aria-modal="true">
        <div class="modal-header">
          <div class="titulo">Seleccionar Cliente</div>
          <button id="cerrarModalClientes" aria-label="Cerrar">‚úñ</button>
          </div>

        <input id="buscadorClientes" type="text" placeholder="Buscar cliente..." autocomplete="off" />

        <div id="listaClientes" class="lista-clientes">
      
        </div>
      </div>
    </div>
<style>
/* Modal overlay (forzado para que no act√∫e como sidebar) */
#modalClientes {
  position: fixed !important;
  inset: 0 !important;
  width: 100% !important;
  height: 100% !important;
  display: none !important;
  justify-content: center !important;
  align-items: center !important;
  background: rgba(0,0,0,0.42) !important;
  z-index: 99999 !important;
  padding: 18px !important;
  box-sizing: border-box !important;
}

/* mostrar */
#modalClientes.active {
  display: flex !important;
}

/* caja modal */
#modalClientes .modal-clientes {
  width: 460px !important;
  max-width: 100% !important;
  max-height: 86vh !important;
  overflow-y: auto !important;
  background: var(--blanco, #fff) !important;
  border-radius: 12px !important;
  box-shadow: 0 14px 40px rgba(0,0,0,0.35) !important;
  padding: 20px !important;
  transform-origin: center center !important;
  animation: modalPop 180ms ease-out !important;
}

/* anim */
@keyframes modalPop {
  from { opacity: 0; transform: translateY(8px) scale(0.98); }
  to   { opacity: 1; transform: translateY(0) scale(1); }
}

/* header modal */
#modalClientes .modal-header {
  display: flex !important;
  justify-content: space-between !important;
  align-items: center !important;
  margin-bottom: 12px !important;
  gap: 12px !important;
}

#modalClientes .modal-header .titulo {
  font-size: 18px !important;
  font-weight: 700 !important;
  color: var(--azul-oscuro, #123452) !important;
}

/* cerrar */
#cerrarModalClientes {
  background: transparent !important;
  border: none !important;
  font-size: 20px !important;
  cursor: pointer !important;
  color: var(--texto, #222) !important;
}

/* buscador */
#buscadorClientes {
  width: 100% !important;
  padding: 10px 12px !important;
  border-radius: 8px !important;
  border: 1px solid #d1d6df !important;
  margin-bottom: 14px !important;
  box-sizing: border-box !important;
  font-size: 14px !important;
}

/* lista / grupos */
#listaClientes { display:block !important; width:100% !important; }
#listaClientes .grupo-clientes { margin-bottom: 12px !important; }
#listaClientes .titulo-grupo { margin: 6px 0 !important; font-size: 13px !important; color: var(--azul-acento, #0b66d6) !important; font-weight:700 !important; }

/* items */
#listaClientes .cliente-item {
  padding: 10px 12px !important;
  border-radius: 8px !important;
  background: var(--azul-claro-fondo, #f5f8fb) !important;
  margin-bottom: 8px !important;
  cursor: pointer !important;
  transition: background 140ms ease, transform 80ms ease !important;
  color: var(--azul-oscuro, #0b2b4a) !important;
  font-weight: 600 !important;
}
#listaClientes .cliente-item:hover {
  background: var(--azul-claro-decorativo, #e6f0ff) !important;
  transform: translateX(4px) !important;
}

/* asegurar que el sidebar no est√© por encima */
#sidebar, .sidebar { z-index: 10 !important; position: relative !important; }

/* responsive */
@media (max-width: 520px) {
  #modalClientes .modal-clientes { width: 96% !important; padding: 14px !important; }
}
</style>
    <script>
document.addEventListener("DOMContentLoaded", () => {
  const btnAbrir = document.getElementById("btnSeleccionarCliente");
  const modal = document.getElementById("modalClientes");
  const btnCerrar = document.getElementById("cerrarModalClientes");
  const lista = document.getElementById("listaClientes");
  const buscador = document.getElementById("buscadorClientes");
  const nombreHeader = document.getElementById("cliente");
  // <-- usa el id real del elemento que muestra la bienvenida (ajusta si es otro)
  const bienvenida = document.getElementById("---");

  // --- helpers ---
  function escapeHtml(txt = "") {
    return String(txt)
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;")
      .replace(/'/g, "&#039;");
  }

  function openModal() {
    if (!modal) return;
    modal.classList.add("active");
    modal.setAttribute("aria-hidden", "false");
    document.body.style.overflow = "hidden";
    if (buscador) {
      buscador.value = "";
      setTimeout(() => buscador.focus(), 50);
    }
    cargarClientes(); // carga inicial
    trapFocus(modal);
  }

  function closeModal() {
    if (!modal) return;
    modal.classList.remove("active");
    modal.setAttribute("aria-hidden", "true");
    document.body.style.overflow = "";
    releaseFocus();
  }

  // focus trap simple
  let lastFocused = null;
  function trapFocus(container) {
    lastFocused = document.activeElement;
    const focusables = 'a[href], area[href], input:not([disabled]), button:not([disabled]), [tabindex="0"]';
    const nodes = Array.from(container.querySelectorAll(focusables));
    if (nodes.length) nodes[0].focus();

    function keyHandler(e) {
      if (e.key === "Tab") {
        const first = nodes[0];
        const last = nodes[nodes.length - 1];
        if (e.shiftKey && document.activeElement === first) {
          e.preventDefault();
          last.focus();
        } else if (!e.shiftKey && document.activeElement === last) {
          e.preventDefault();
          first.focus();
        }
      } else if (e.key === "Escape") {
        closeModal();
      }
    }
    container._keyHandler = keyHandler;
    document.addEventListener("keydown", keyHandler);
  }
  function releaseFocus() {
    if (modal && modal._keyHandler) {
      document.removeEventListener("keydown", modal._keyHandler);
      delete modal._keyHandler;
    }
    if (lastFocused) lastFocused.focus();
    lastFocused = null;
  }

  // --- eventos abrir/cerrar ---
  if (btnAbrir) btnAbrir.addEventListener("click", (e) => { e.preventDefault(); openModal(); });
  if (btnCerrar) btnCerrar.addEventListener("click", closeModal);
  if (modal) {
    modal.addEventListener("click", (e) => {
      if (e.target === modal) closeModal();
    });
  }

  async function cargarClientes(q = "") {
    if (!lista) return;
    lista.innerHTML = '<div class="loading">Cargando clientes...</div>';
    try {
      const url = '../../clientes_json.php' + (q ? '?q=' + encodeURIComponent(q) : '');
      const resp = await fetch(url, { cache: 'no-store' });
      if (!resp.ok) throw new Error('HTTP ' + resp.status);
      const data = await resp.json();
      renderClientes(data || []);
    } catch (err) {
      console.error('Error cargando clientes:', err);
      if (lista) lista.innerHTML = '<div class="error">Error al cargar clientes.</div>';
    }
  }

  function renderClientes(items) {
    if (!lista) return;
    lista.innerHTML = '';
    if (!Array.isArray(items) || items.length === 0) {
      lista.innerHTML = '<div class="no-results">No se encontraron clientes.</div>';
      return;
    }
    items.forEach(it => {
      const grupo = document.createElement('div');
      grupo.className = 'grupo-clientes';

      const h = document.createElement('h4');
      h.className = 'titulo-grupo';
      h.textContent = 'ID ' + String(it.id);
      grupo.appendChild(h);

      const cliente = document.createElement('div');
      cliente.className = 'cliente-item';
      cliente.setAttribute('role', 'button');
      cliente.setAttribute('tabindex', '0');
      cliente.dataset.id = String(it.id);
      cliente.dataset.nombre = String(it.nombre || '');
      cliente.innerHTML = escapeHtml(String(it.nombre || 'Sin nombre'));
      cliente.addEventListener('click', () => seleccionarCliente(cliente));
      cliente.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          seleccionarCliente(cliente);
        }
      });

      grupo.appendChild(cliente);
      lista.appendChild(grupo);
    });
  }

  // formateador de moneda (S/ 1,234.56)
  function formatSoles(value) {
    return 'S/ ' + Number(value || 0).toLocaleString('es-PE', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
  }

  // llamada al servidor para obtener sumas por cliente
  async function fetchResumenCliente(clienteId) {
    const ingEl = document.getElementById('stat-ingresos-value');
    const egEl = document.getElementById('stat-egresos-value');

    try {
      if (!clienteId) {
        if (ingEl) ingEl.innerText = formatSoles(0);
        if (egEl) egEl.innerText = formatSoles(0);
        return;
      }
      const resp = await fetch('resumen_cliente.php?cliente_id=' + encodeURIComponent(clienteId), { cache: 'no-store' });
      if (!resp.ok) throw new Error('HTTP ' + resp.status);
      const data = await resp.json();
      const ing = Number(data.ingresos_total || 0);
      const eg = Number(data.egresos_total || 0);
      if (ingEl) ingEl.innerText = formatSoles(ing);
      if (egEl) egEl.innerText = formatSoles(eg);
    } catch (err) {
      console.error('Error cargando resumen cliente:', err);
      if (ingEl) ingEl.innerText = formatSoles(0);
      if (egEl) egEl.innerText = formatSoles(0);
    }
  }

  // seleccionar cliente (actualizado: actualiza montos)
  function seleccionarCliente(itemEl) {
  const nombre = itemEl.dataset.nombre || itemEl.textContent.trim();
  const id = itemEl.dataset.id || '';

  // actualizar UI: nombre en header y en el input filtro
  const nombreHeader = document.getElementById("cliente-nombre");
  const clienteFiltro = document.getElementById("clienteFiltro");
  if (nombreHeader) nombreHeader.innerText = nombre;
  if (clienteFiltro) clienteFiltro.value = nombre;

  // guardamos el cliente seleccionado en ventana global (usado al filtrar)
  window.clienteSeleccionadoId = id ? String(id) : null;
  window.clienteSeleccionadoNombre = nombre || null;

  console.log('[modal] cliente seleccionado (guardado como filtro):', window.clienteSeleccionadoId, window.clienteSeleccionadoNombre);

  // cerrar modal (NO cargar datos aqu√≠)
  closeModal();
}


  let debounceTimer = null;
  if (buscador) {
    buscador.addEventListener('input', () => {
      const q = buscador.value.trim();
      clearTimeout(debounceTimer);
      debounceTimer = setTimeout(() => {
        if (q.length === 0) cargarClientes();
        else cargarClientes(q);
      }, 250);
    });
  }

}); // DOMContentLoaded
</script>
    <div class="filter-section">
      <label for="tipo">Tipo:</label>
      <select id="tipo">
        <option value="ventas">Ventas</option>
        <option value="compras">Compras</option>
        
      </select>

      <label for="fechaInicio">Desde:</label>
      <input type="date" id="fechaInicio">

      <label for="fechaFin">Hasta:</label>
      <input type="date" id="fechaFin">

      <label for="clienteFiltro">Cliente (seleccionado):</label>
      <input type="text" id="clienteFiltro" placeholder="Ning√∫n cliente" readonly style="background:#f5f5f5;">
      


      <button id="filtrar">Filtrar</button>


    </div>

    <div class="report-container">
      <table id="tablaReportes">
        <thead>
          <tr>
            <th><input type="checkbox" id="selectAll"></th>
            <th>Fecha</th>
            <th>Documento</th>
            <th>Entidad</th>
            <th>Descripci√≥n</th>
            <th>Monto (S/)</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <div class="totales">
        Total general: <span id="total">S/ 0.00</span>
      </div>
    </div>
  </main>

<script src="script_reportes_contador.js"></script>
<script src="/script.js"></script>
</body>
</html>
